<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>Eunoia App</title>

    <!-- Fonts (Manus/ChatGPT-like) -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Tailwind CDN (simple) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Markdown + sanitizer -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>

    <style>
      :root {
        --paper: #f7f7fb;
        --ink: #0f172a;
        --muted: rgba(15, 23, 42, 0.55);
      }

      html,
      body {
        height: 100%;
      }

      body {
        font-family: Inter, "Noto Sans SC", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        background: var(--paper);
        color: var(--ink);
      }

      /* Manus-ish soft cards */
      .soft-card {
        background: rgba(255, 255, 255, 0.78);
        border: 1px solid rgba(15, 23, 42, 0.06);
        box-shadow: 0 10px 30px rgba(15, 23, 42, 0.06);
        border-radius: 18px;
      }

      .icon-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        border-radius: 12px;
        padding: 10px;
        transition: background 120ms ease;
      }
      .icon-btn:hover {
        background: rgba(0, 0, 0, 0.05);
      }

      .pill {
        border-radius: 999px;
        padding: 2px 10px;
        font-size: 12px;
        font-weight: 600;
        background: rgba(0, 0, 0, 0.05);
        color: rgba(15, 23, 42, 0.55);
      }

      /* message markdown */
      .msg-md {
        line-height: 1.55;
        word-break: break-word;
      }
      .msg-md p {
        margin: 0.5rem 0;
      }
      .msg-md pre {
        background: rgba(15, 23, 42, 0.06);
        border: 1px solid rgba(15, 23, 42, 0.08);
        border-radius: 12px;
        padding: 12px;
        overflow: auto;
      }
      .msg-md code {
        background: rgba(15, 23, 42, 0.06);
        border: 1px solid rgba(15, 23, 42, 0.08);
        border-radius: 8px;
        padding: 2px 6px;
        font-size: 0.92em;
      }
      .msg-md pre code {
        background: transparent;
        border: none;
        padding: 0;
      }

      /* nicer scrollbars */
      * {
        scrollbar-width: thin;
        scrollbar-color: rgba(0, 0, 0, 0.18) transparent;
      }
      *::-webkit-scrollbar {
        width: 10px;
        height: 10px;
      }
      *::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.18);
        border-radius: 999px;
        border: 3px solid transparent;
        background-clip: padding-box;
      }

      /* toast */
      #toast {
        position: fixed;
        left: 50%;
        transform: translateX(-50%);
        bottom: 22px;
        z-index: 1000;
        display: none;
      }

      /* typing cursor */
      .cursor {
        display: inline-block;
        width: 8px;
        height: 16px;
        background: rgba(15, 23, 42, 0.55);
        margin-left: 4px;
        border-radius: 2px;
        animation: blink 1s infinite;
        vertical-align: -2px;
      }
      @keyframes blink {
        0%,
        49% {
          opacity: 1;
        }
        50%,
        100% {
          opacity: 0;
        }
      }

      /* --- Icon-only collapsed sidebar (Manus-like) --- */
      aside.sidebar {
        transition: width 160ms ease;
      }
      aside.sidebar.is-collapsed {
        width: 72px !important;
      }

      /* Hide text labels / extra rows in collapsed mode */
      aside.sidebar.is-collapsed .sidebar-label,
      aside.sidebar.is-collapsed .sidebar-sub,
      aside.sidebar.is-collapsed #searchRow,
      aside.sidebar.is-collapsed #chatCountPill,
      aside.sidebar.is-collapsed .sidebar-footer,
      aside.sidebar.is-collapsed .chat-title,
      aside.sidebar.is-collapsed [data-ellipsis] {
        display: none !important;
      }

      /* Tighten padding/centering for collapsed rail */
      aside.sidebar.is-collapsed .brand-row {
        justify-content: center;
      }
      aside.sidebar.is-collapsed .brand-row a {
        justify-content: center;
        gap: 0;
        padding-left: 0.75rem;
        padding-right: 0.75rem;
      }
      aside.sidebar.is-collapsed .primary-actions,
      aside.sidebar.is-collapsed .secondary-actions {
        padding-left: 0.5rem;
        padding-right: 0.5rem;
      }
      aside.sidebar.is-collapsed .action-btn {
        justify-content: center;
        padding-left: 0.5rem !important;
        padding-right: 0.5rem !important;
      }

      /* Chat dots list (collapsed rail) */
      .chat-dot {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        background: rgba(17, 24, 39, 0.3);
      }
      .chat-dot.active {
        background: rgba(17, 24, 39, 0.75);
      }

      .chat-dot-btn {
        width: 40px;
        height: 40px;
        border-radius: 14px;
        display: grid;
        place-items: center;
        transition: background 120ms ease;
      }
      .chat-dot-btn:hover {
        background: rgba(0, 0, 0, 0.05);
      }
    </style>

    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              paper: "var(--paper)",
              ink: "var(--ink)",
              muted: "var(--muted)",
            },
          },
        },
      };
    </script>
  </head>

  <body class="text-ink">
    <div class="h-full flex">
      <!-- Sidebar -->
      <aside
        id="sidebar"
        class="sidebar fixed md:static inset-y-0 left-0 z-50 w-[296px] md:w-[296px] shrink-0 bg-paper/70 backdrop-blur border-r border-black/5 transform -translate-x-full md:translate-x-0 transition-transform duration-200 ease-out"
      >
        <div class="h-full flex flex-col">
          <!-- Brand -->
          <div class="brand-row">
            <a href="/landing" class="px-4 pt-5 pb-3 flex items-center gap-3 hover:opacity-90">
              <!-- Sketch logo (inline SVG) -->
              <svg width="26" height="26" viewBox="0 0 26 26" fill="none" aria-hidden="true">
                <path
                  d="M7.4 2.8h11.2c.35 0 .68.17.88.46l3.67 5.12c.23.32.25.75.05 1.1L13.8 23.3c-.34.37-.92.39-1.29.05l-.05-.05L2.8 9.48a1.02 1.02 0 0 1 .05-1.1l3.67-5.12c.2-.28.53-.46.88-.46Z"
                  fill="#111827"
                  opacity="0.08"
                />
                <path
                  d="M13 23.5 2.8 9.35 6.6 3.8h12.8l3.8 5.55L13 23.5Z"
                  stroke="#111827"
                  stroke-width="1.2"
                  stroke-linejoin="round"
                />
                <path d="M6.4 3.8 13 23.5 19.6 3.8" stroke="#111827" stroke-width="1.2" opacity="0.7" />
                <path d="M2.8 9.35h20.4" stroke="#111827" stroke-width="1.2" opacity="0.7" />
              </svg>

              <div class="sidebar-label font-semibold tracking-tight text-[15px]">Eunoia</div>
              <div class="sidebar-sub text-xs text-black/40">web</div>
            </a>
          </div>

          <!-- Primary actions -->
          <div class="primary-actions px-3">
            <button
              id="newTaskBtn"
              class="action-btn w-full flex items-center gap-2 rounded-xl px-3 py-2.5 text-sm font-semibold bg-slate-900/80 text-white hover:bg-black"
            >
              <!-- pencil -->
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path
                  d="M12 20h9"
                  stroke="white"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  opacity="0.9"
                />
                <path
                  d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5Z"
                  stroke="white"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
              <span class="sidebar-label">New chat</span>
            </button>
          </div>

          <!-- Secondary actions -->
          <div class="secondary-actions px-3 mt-3 space-y-1">
            <button
              id="searchToggleBtn"
              class="action-btn w-full flex items-center gap-2 rounded-xl px-3 py-2 text-sm text-black/80 hover:bg-black/5"
            >
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path
                  d="M10 18a8 8 0 1 1 0-16 8 8 0 0 1 0 16Z"
                  stroke="#111827"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
                <path
                  d="m21 21-4.35-4.35"
                  stroke="#111827"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  opacity="0.8"
                />
              </svg>
              <span class="sidebar-label">Search</span>
            </button>

            <div id="searchRow" class="hidden px-2 py-2">
              <input
                id="searchInput"
                class="w-full rounded-xl border border-black/10 bg-white/70 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-black/10"
                placeholder="Search"
              />
            </div>
          </div>

          <!-- Chats header -->
          <div class="mt-4 px-3 flex items-center justify-between">
            <div class="text-xs font-semibold text-black/40 uppercase tracking-wider">Chats</div>
            <div id="chatCountPill" class="pill">1</div>
          </div>

          <!-- Chat list -->
          <div id="chatList" class="mt-2 px-2 pb-3 overflow-auto"></div>

          <div class="flex-1"></div>

          <!-- Footer -->
          <div class="sidebar-footer px-3 py-3 border-t border-black/5">
            <div class="flex items-center justify-between gap-2">
              <button id="resetBtn" class="icon-btn" title="Reset">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path
                    d="M3 12a9 9 0 1 0 3-6.7"
                    stroke="#111827"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                  <path d="M3 3v6h6" stroke="#111827" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
              </button>
              <div class="text-xs text-black/35">Streaming</div>
            </div>
          </div>
        </div>
      </aside>

      <!-- Mobile overlay -->
      <div id="sidebarOverlay" class="fixed inset-0 z-40 bg-black/30 hidden md:hidden"></div>

      <!-- Main -->
      <main class="flex-1 min-w-0">
        <!-- Top bar -->
        <header class="sticky top-0 z-30 h-14 bg-paper/75 backdrop-blur border-b border-black/5">
          <div class="h-full px-6 flex items-center">
            <!-- Left: model dropdown -->
            <div class="flex items-center gap-3">
              <button
                id="sidebarToggleBtn"
                class="icon-btn md:hidden"
                type="button"
                aria-label="Open sidebar"
                title="Menu"
              >
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M4 6h16M4 12h16M4 18h16" stroke="#111827" stroke-width="2" stroke-linecap="round" />
                </svg>
              </button>

              <div class="relative">
                <button
                  id="modelBtn"
                  class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-semibold hover:bg-slate-50"
                >
                  <div class="flex items-center gap-1">
                    <div id="modelName" class="text-sm font-semibold text-black/80">Eunoia</div>
                    <span id="modelTierPill" class="text-xs rounded-full px-2 py-0.5 bg-black/5 text-black/35">Lite</span>
                    <span class="text-xs text-slate-500">‚ñæ</span>
                  </div>
                </button>

                <div
                  id="modelMenu"
                  class="absolute left-0 mt-2 w-56 soft-card p-2 hidden"
                >
                  <button
                    data-model="eunoia-lite"
                    class="w-full text-left px-3 py-2 rounded-xl hover:bg-black/5"
                  >
                    <div class="text-sm font-semibold">Eunoia</div>
                    <div class="text-xs text-black/40">Lite</div>
                  </button>
                </div>
              </div>
            </div>

            <div class="flex-1"></div>

            <!-- Right: user actions -->
            <div class="flex items-center gap-2">
              <button id="shareBtn" class="icon-btn" title="Share">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path
                    d="M4 12v7a1 1 0 0 0 1 1h14a1 1 0 0 0 1-1v-7"
                    stroke="#111827"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                  <path
                    d="M16 6l-4-4-4 4"
                    stroke="#111827"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                  <path
                    d="M12 2v13"
                    stroke="#111827"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                </svg>
              </button>

              <button id="inviteBtn" class="icon-btn" title="Invite">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path
                    d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"
                    stroke="#111827"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                  <path
                    d="M12 11a4 4 0 1 0 0-8 4 4 0 0 0 0 8Z"
                    stroke="#111827"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                  <path
                    d="M19 8v6"
                    stroke="#111827"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    opacity="0.85"
                  />
                  <path
                    d="M22 11h-6"
                    stroke="#111827"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    opacity="0.85"
                  />
                </svg>
              </button>

              <button id="settingsBtn" class="icon-btn" title="Settings">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path
                    d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z"
                    stroke="#111827"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                  <path
                    d="M19.4 15a1.8 1.8 0 0 0 .36 1.98l.06.06a2.2 2.2 0 0 1 0 3.12 2.2 2.2 0 0 1-3.12 0l-.06-.06a1.8 1.8 0 0 0-1.98-.36 1.8 1.8 0 0 0-1.08 1.65V21a2.2 2.2 0 0 1-4.4 0v-.08A1.8 1.8 0 0 0 8.1 19.3a1.8 1.8 0 0 0-1.98.36l-.06.06a2.2 2.2 0 0 1-3.12 0 2.2 2.2 0 0 1 0-3.12l.06-.06A1.8 1.8 0 0 0 3.4 15a1.8 1.8 0 0 0-1.65-1.08H1.7a2.2 2.2 0 0 1 0-4.4h.08A1.8 1.8 0 0 0 3.4 8.1a1.8 1.8 0 0 0-.36-1.98l-.06-.06a2.2 2.2 0 0 1 0-3.12 2.2 2.2 0 0 1 3.12 0l.06.06A1.8 1.8 0 0 0 8.1 3.4a1.8 1.8 0 0 0 1.08-1.65V1.7a2.2 2.2 0 0 1 4.4 0v.08A1.8 1.8 0 0 0 15.9 3.4a1.8 1.8 0 0 0 1.98-.36l.06-.06a2.2 2.2 0 0 1 3.12 0 2.2 2.2 0 0 1 0 3.12l-.06.06A1.8 1.8 0 0 0 20.6 8.1a1.8 1.8 0 0 0 1.65 1.08h.08a2.2 2.2 0 0 1 0 4.4h-.08A1.8 1.8 0 0 0 19.4 15Z"
                    stroke="#111827"
                    stroke-width="1.6"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    opacity="0.65"
                  />
                </svg>
              </button>
            </div>
          </div>
        </header>

        <!-- Content -->
        <div class="px-6 pb-6">
          <!-- Conversation area -->
          <section class="mt-6">
            <div class="max-w-3xl mx-auto">
              <!-- Header / intro (shows when empty) -->
              <div id="emptyState" class="soft-card p-7">
                <div class="text-2xl font-semibold tracking-tight mb-1">Hi! Tell me your interests</div>
                <div class="text-black/50">Pick a track to get started:</div>

                <div class="mt-5 grid grid-cols-1 sm:grid-cols-2 gap-3">
                  <button
                    class="exampleBtn soft-card !shadow-none border border-black/5 p-4 text-left hover:bg-black/5 transition"
                    data-text="I‚Äôm a CS PhD focused on NLP / LLMs. Suggest programs/labs and explain fit."
                  >
                    <div class="text-sm font-semibold">üìö CS PhD ¬∑ NLP / LLMs</div>
                    <div class="text-xs text-black/45 mt-1">Programs, labs, advisors</div>
                  </button>

                  <button
                    class="exampleBtn soft-card !shadow-none border border-black/5 p-4 text-left hover:bg-black/5 transition"
                    data-text="I‚Äôm into HCI and user studies. Suggest programs/labs and explain fit."
                  >
                    <div class="text-sm font-semibold">‚úèÔ∏è HCI ¬∑ User Studies</div>
                    <div class="text-xs text-black/45 mt-1">Methods, advisors, topics</div>
                  </button>

                  <button
                    class="exampleBtn soft-card !shadow-none border border-black/5 p-4 text-left hover:bg-black/5 transition"
                    data-text="I‚Äôm into CV + Robotics. Suggest programs/labs and explain fit."
                  >
                    <div class="text-sm font-semibold">üß† CV + Robotics</div>
                    <div class="text-xs text-black/45 mt-1">Perception, SLAM, navigation</div>
                  </button>

                  <button
                    class="exampleBtn soft-card !shadow-none border border-black/5 p-4 text-left hover:bg-black/5 transition"
                    data-text="I‚Äôm not sure yet. Ask me questions to narrow down."
                  >
                    <div class="text-sm font-semibold">üß∞ Not sure yet</div>
                    <div class="text-xs text-black/45 mt-1">We‚Äôll figure it out</div>
                  </button>
                </div>
              </div>

              <!-- Messages -->
              <div id="messages" class="mt-5 space-y-3"></div>
            </div>
          </section>

          <!-- Composer -->
          <section class="mt-6">
            <div class="max-w-3xl mx-auto">
              <div class="soft-card p-3">
                <div class="flex items-end gap-2">
                  <button id="attachBtn" class="icon-btn" title="Attach">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                      <path
                        d="M21.44 11.05 12 20.5a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.2a2 2 0 0 1-2.83-2.83l8.49-8.49"
                        stroke="#111827"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      />
                    </svg>
                  </button>

                  <textarea
                    id="chatInput"
                    rows="1"
                    class="flex-1 resize-none rounded-2xl border border-black/10 bg-white/70 px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-black/10 max-h-40"
                    placeholder="Send a message‚Ä¶"
                  ></textarea>

                  <button id="sendBtn" class="icon-btn" title="Send">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                      <path
                        d="M22 2 11 13"
                        stroke="#111827"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      />
                      <path
                        d="M22 2 15 22l-4-9-9-4 20-7Z"
                        stroke="#111827"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      />
                    </svg>
                  </button>

                  <button id="stopBtn" class="icon-btn hidden" title="Stop">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                      <path
                        d="M6 6h12v12H6V6Z"
                        stroke="#111827"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      />
                    </svg>
                  </button>
                </div>

                <div class="px-2 pt-2 text-[12px] text-black/35">
                  Shift+Enter for newline ¬∑ Enter to send
                </div>
              </div>
            </div>
          </section>
        </div>

        <!-- Context menu -->
        <div id="ctxMenu" class="hidden fixed z-[999] soft-card p-2 w-44">
          <button id="renameChatBtn" class="w-full text-left px-3 py-2 rounded-xl hover:bg-black/5 text-sm">Rename</button>
          <button id="deleteChatBtn" class="w-full text-left px-3 py-2 rounded-xl hover:bg-black/5 text-sm text-red-600">Delete</button>
        </div>
      </main>
    </div>

    <!-- toast -->
    <div id="toast" class="soft-card px-4 py-3 text-sm text-black/80"></div>

    <script>
      // ----------------------------
      // Storage / state
      // ----------------------------
      const LS_CHATS = "eunoia_chats_v3";
      const LS_SELECTED = "eunoia_selected_chat_v3";

      // Sidebar: mobile drawer + desktop icon-only rail
      const LS_SIDEBAR_COLLAPSED = "eunoia_sidebar_collapsed_v1";
      let sidebarCollapsed = localStorage.getItem(LS_SIDEBAR_COLLAPSED) === "1";
      let sidebarOpen = false; // mobile drawer

      const sidebarEl = document.getElementById("sidebar");
      const sidebarOverlayEl = document.getElementById("sidebarOverlay");
      const sidebarToggleBtn = document.getElementById("sidebarToggleBtn");
      const collapseSidebarBtn = document.getElementById("collapseSidebarBtn"); // optional (desktop)

      function isMobile() {
        return window.innerWidth < 768; // Tailwind md breakpoint
      }

      function applySidebarState() {
        if (!sidebarEl) return;

        // MOBILE: off-canvas drawer
        if (isMobile()) {
          sidebarEl.classList.toggle("-translate-x-full", !sidebarOpen);
          sidebarEl.classList.toggle("translate-x-0", sidebarOpen);

          if (sidebarOverlayEl) {
            sidebarOverlayEl.classList.toggle("hidden", !sidebarOpen);
          }

          // Mobile never uses collapsed rail
          sidebarEl.classList.remove("is-collapsed");
          return;
        }

        // DESKTOP: always visible
        sidebarOpen = false;
        if (sidebarOverlayEl) sidebarOverlayEl.classList.add("hidden");
        sidebarEl.classList.remove("-translate-x-full");
        sidebarEl.classList.add("translate-x-0");

        // Apply collapsed rail
        sidebarEl.classList.toggle("is-collapsed", sidebarCollapsed);
      }

      function setSidebarCollapsed(next) {
        sidebarCollapsed = !!next;
        localStorage.setItem(LS_SIDEBAR_COLLAPSED, sidebarCollapsed ? "1" : "0");
        applySidebarState();
        renderChatList();
      }

      function openSidebar() {
        sidebarOpen = true;
        applySidebarState();
      }
      function closeSidebar() {
        sidebarOpen = false;
        applySidebarState();
      }
      function toggleSidebar() {
        sidebarOpen = !sidebarOpen;
        applySidebarState();
      }

      sidebarToggleBtn?.addEventListener("click", toggleSidebar);
      sidebarOverlayEl?.addEventListener("click", closeSidebar);

      // Optional desktop collapse button (if present)
      collapseSidebarBtn?.addEventListener("click", () => setSidebarCollapsed(!sidebarCollapsed));

      // Shortcut: Ctrl/Cmd + B toggles collapsed rail (desktop)
      document.addEventListener("keydown", (e) => {
        const isMac = navigator.platform.toLowerCase().includes("mac");
        const mod = isMac ? e.metaKey : e.ctrlKey;
        if (mod && e.key.toLowerCase() === "b" && !isMobile()) {
          e.preventDefault();
          setSidebarCollapsed(!sidebarCollapsed);
        }
        if (e.key === "Escape" && isMobile()) closeSidebar();
      });

      window.addEventListener("resize", () => {
        // Reset drawer on resize and re-apply correct mode
        sidebarOpen = false;
        applySidebarState();
        renderChatList();
      });

      let chats = [];
      let selectedChatId = null;

      const STORAGE_KEY = "eunoia_prev_response_id";
      let previousResponseId = localStorage.getItem(STORAGE_KEY) || "";

      // ----------------------------
      // Elements
      // ----------------------------
      const chatListEl = document.getElementById("chatList");
      const newTaskBtn = document.getElementById("newTaskBtn");
      const resetBtn = document.getElementById("resetBtn");

      const searchToggleBtn = document.getElementById("searchToggleBtn");
      const searchRowEl = document.getElementById("searchRow");
      const searchInputEl = document.getElementById("searchInput");
      const chatCountPill = document.getElementById("chatCountPill");

      const modelBtn = document.getElementById("modelBtn");
      const modelMenu = document.getElementById("modelMenu");
      const modelNameEl = document.getElementById("modelName");
      const modelTierPillEl = document.getElementById("modelTierPill");

      const emptyStateEl = document.getElementById("emptyState");
      const messagesEl = document.getElementById("messages");
      const chatInputEl = document.getElementById("chatInput");
      const sendBtn = document.getElementById("sendBtn");
      const stopBtn = document.getElementById("stopBtn");

      const ctxMenuEl = document.getElementById("ctxMenu");
      const renameChatBtn = document.getElementById("renameChatBtn");
      const deleteChatBtn = document.getElementById("deleteChatBtn");

      const toastEl = document.getElementById("toast");

      // ----------------------------
      // Helpers
      // ----------------------------
      function now() {
        return Date.now();
      }

      function uuid() {
        return Math.random().toString(16).slice(2) + "-" + Math.random().toString(16).slice(2);
      }

      function showToast(text) {
        toastEl.textContent = text;
        toastEl.style.display = "block";
        clearTimeout(showToast._t);
        showToast._t = setTimeout(() => (toastEl.style.display = "none"), 1800);
      }

      function clamp(n, a, b) {
        return Math.max(a, Math.min(b, n));
      }

      function autoGrowTextarea(el) {
        const max = 160;
        el.style.height = "auto";
        el.style.height = clamp(el.scrollHeight, 0, max) + "px";
      }

      function setUrlChat(id) {
        const u = new URL(location.href);
        if (id) u.searchParams.set("chat", id);
        else u.searchParams.delete("chat");
        history.replaceState(null, "", u.toString());
      }

      function getUrlChat() {
        const u = new URL(location.href);
        return u.searchParams.get("chat");
      }

      function persist() {
        localStorage.setItem(LS_CHATS, JSON.stringify(chats));
        localStorage.setItem(LS_SELECTED, selectedChatId || "");
      }

      function loadState() {
        try {
          chats = JSON.parse(localStorage.getItem(LS_CHATS) || "[]") || [];
        } catch {
          chats = [];
        }
        selectedChatId = localStorage.getItem(LS_SELECTED) || null;

        if (!chats.length) {
          const id = uuid();
          chats = [
            {
              id,
              title: "Unclear Input or Typo",
              createdAt: now(),
              messages: [],
            },
          ];
          selectedChatId = id;
          persist();
        }

        if (!selectedChatId || !chats.some((c) => c.id === selectedChatId)) {
          selectedChatId = chats[0]?.id || null;
          persist();
        }
      }

      function applyChatFromUrl() {
        const id = getUrlChat();
        if (id && chats.some((c) => c.id === id)) {
          selectedChatId = id;
          persist();
        }
      }

      function currentChat() {
        return chats.find((c) => c.id === selectedChatId) || chats[0];
      }

      function ensureChatTitle(c) {
        if (!c.title || !c.title.trim()) c.title = "Untitled";
      }

      function safeMarkdown(md) {
        const raw = marked.parse(md || "");
        return DOMPurify.sanitize(raw, { USE_PROFILES: { html: true } });
      }

      function scrollToBottom() {
        window.requestAnimationFrame(() => {
          const el = document.scrollingElement || document.documentElement;
          el.scrollTop = el.scrollHeight;
        });
      }

      // ----------------------------
      // Context menu
      // ----------------------------
      let ctxChatId = null;
      function openCtxMenu(chatId, anchorEl) {
        ctxChatId = chatId;
        const rect = anchorEl.getBoundingClientRect();
        ctxMenuEl.style.left = rect.left + "px";
        ctxMenuEl.style.top = rect.bottom + 8 + "px";
        ctxMenuEl.classList.remove("hidden");
      }

      function closeCtxMenu() {
        ctxChatId = null;
        ctxMenuEl.classList.add("hidden");
      }

      document.addEventListener("click", (e) => {
        if (!ctxMenuEl.contains(e.target)) closeCtxMenu();
      });

      renameChatBtn.addEventListener("click", () => {
        const c = chats.find((x) => x.id === ctxChatId);
        if (!c) return;
        const next = prompt("Rename chat:", c.title || "");
        if (next === null) return;
        c.title = (next || "").trim() || "Untitled";
        persist();
        renderAll();
        closeCtxMenu();
      });

      deleteChatBtn.addEventListener("click", () => {
        const idx = chats.findIndex((x) => x.id === ctxChatId);
        if (idx < 0) return;
        const ok = confirm("Delete this chat?");
        if (!ok) return;

        const wasSelected = chats[idx].id === selectedChatId;
        chats.splice(idx, 1);

        if (!chats.length) {
          const id = uuid();
          chats.push({ id, title: "New chat", createdAt: now(), messages: [] });
          selectedChatId = id;
        } else if (wasSelected) {
          selectedChatId = chats[0].id;
        }

        persist();
        renderAll();
        closeCtxMenu();
      });

      // ----------------------------
      // Render chat list + dots
      // ----------------------------
      function renderChatList() {
        const q = (searchInputEl?.value || "").trim().toLowerCase();
        const items = chats
          .slice()
          .sort((a, b) => b.createdAt - a.createdAt)
          .filter((c) => !q || (c.title || "").toLowerCase().includes(q));

        // pill count (hidden in collapsed via CSS)
        chatCountPill.classList.toggle("hidden", items.length === 0);
        chatCountPill.textContent = String(items.length);

        chatListEl.innerHTML = "";

        // COLLAPSED: render dot rail
        if (sidebarCollapsed && !isMobile()) {
          chatListEl.classList.remove("px-2");
          chatListEl.classList.add("px-0");

          for (const c of items) {
            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "chat-dot-btn mx-auto my-1";
            btn.title = c.title || "Untitled";

            const dot = document.createElement("div");
            dot.className = "chat-dot" + (c.id === selectedChatId ? " active" : "");
            btn.appendChild(dot);

            btn.addEventListener("click", () => {
              selectedChatId = c.id;
              persist();
              renderAll();
              if (isMobile()) closeSidebar();
            });

            btn.addEventListener("contextmenu", (e) => {
              e.preventDefault();
              openCtxMenu(c.id, btn);
            });

            chatListEl.appendChild(btn);
          }
          return;
        }

        // EXPANDED: title list
        chatListEl.classList.add("px-2");
        chatListEl.classList.remove("px-0");

        for (const c of items) {
          const row = document.createElement("div");
          row.className =
            "group relative rounded-xl px-3 py-2.5 mx-1 cursor-pointer " +
            (c.id === selectedChatId ? "bg-black/5" : "hover:bg-black/5");

          const title = document.createElement("div");
          title.className = "chat-title text-sm text-black/80 truncate pr-10";
          title.textContent = c.title || "Untitled";

          const ell = document.createElement("button");
          ell.type = "button";
          ell.setAttribute("data-ellipsis", "1");
          ell.className =
            "absolute right-2 top-1/2 -translate-y-1/2 icon-btn !p-1.5 opacity-0 group-hover:opacity-100 transition";
          ell.innerHTML = `
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 5.5a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3Zm0 5a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3Zm0 5a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3Z" fill="#111827"/>
        </svg>
      `;

          ell.addEventListener("click", (e) => {
            e.stopPropagation();
            openCtxMenu(c.id, ell);
          });

          row.appendChild(title);
          row.appendChild(ell);

          row.addEventListener("click", () => {
            selectedChatId = c.id;
            persist();
            renderAll();
            if (isMobile()) closeSidebar();
          });

          chatListEl.appendChild(row);
        }
      }

      // ----------------------------
      // Render messages
      // ----------------------------
      function renderMessages() {
        const c = currentChat();
        const msgs = c.messages || [];

        emptyStateEl.classList.toggle("hidden", msgs.length > 0);
        messagesEl.innerHTML = "";

        for (const m of msgs) {
          const wrap = document.createElement("div");
          wrap.className = "soft-card p-4";

          const head = document.createElement("div");
          head.className = "flex items-center justify-between mb-2";

          const role = document.createElement("div");
          role.className = "text-xs font-semibold text-black/40 uppercase tracking-wider";
          role.textContent = m.role === "user" ? "You" : "Eunoia";

          const time = document.createElement("div");
          time.className = "text-[11px] text-black/35";
          time.textContent = new Date(m.ts || now()).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });

          head.appendChild(role);
          head.appendChild(time);

          const body = document.createElement("div");
          body.className = "msg-md text-sm text-black/80";
          body.innerHTML = safeMarkdown(m.text || "");

          wrap.appendChild(head);
          wrap.appendChild(body);
          messagesEl.appendChild(wrap);
        }
      }

      function renderExamplePrompts() {
        // already in static HTML; nothing special needed
      }

      // ----------------------------
      // Model menu
      // ----------------------------
      modelBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        modelMenu.classList.toggle("hidden");
      });
      document.addEventListener("click", () => modelMenu.classList.add("hidden"));

      modelMenu.addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-model]");
        if (!btn) return;
        const m = btn.getAttribute("data-model");
        if (m === "eunoia-lite") {
          modelNameEl.textContent = "Eunoia";
          modelTierPillEl.textContent = "Lite";
        }
        showToast("Model set");
        modelMenu.classList.add("hidden");
      });

      // ----------------------------
      // Sidebar actions
      // ----------------------------
      searchToggleBtn.addEventListener("click", () => {
        searchRowEl.classList.toggle("hidden");
        if (!searchRowEl.classList.contains("hidden")) {
          searchInputEl.focus();
        } else {
          searchInputEl.value = "";
          renderChatList();
        }
      });

      searchInputEl.addEventListener("input", () => renderChatList());

      newTaskBtn.addEventListener("click", () => {
        const id = uuid();
        chats.unshift({ id, title: "New chat", createdAt: now(), messages: [] });
        selectedChatId = id;
        previousResponseId = "";
        localStorage.removeItem(STORAGE_KEY);
        persist();
        setUrlChat(id);
        renderAll();
        showToast("New chat created");
        if (isMobile()) closeSidebar();
      });

      resetBtn.addEventListener("click", () => {
        const ok = confirm("Reset the app? (Clears chats + state)");
        if (!ok) return;
        localStorage.removeItem(LS_CHATS);
        localStorage.removeItem(LS_SELECTED);
        localStorage.removeItem(STORAGE_KEY);
        location.reload();
      });

      // Example prompt buttons
      document.querySelectorAll(".exampleBtn").forEach((btn) => {
        btn.addEventListener("click", () => {
          chatInputEl.value = btn.getAttribute("data-text") || "";
          autoGrowTextarea(chatInputEl);
          chatInputEl.focus();
        });
      });

      // ----------------------------
      // Chat send + streaming
      // ----------------------------
      let abortController = null;

      function addMessage(role, text) {
        const c = currentChat();
        c.messages = c.messages || [];
        c.messages.push({ role, text, ts: now() });
        ensureChatTitle(c);
        persist();
      }

      function guessTitleFromUser(text) {
        const t = (text || "").trim();
        if (!t) return "Untitled";
        return t.length > 28 ? t.slice(0, 28) + "‚Ä¶" : t;
      }

      function setChatTitleIfDefault(c, userText) {
        if (c.title === "New chat" || c.title === "Untitled") {
          c.title = guessTitleFromUser(userText);
        }
      }

      async function streamChat(userText) {
        const c = currentChat();
        addMessage("user", userText);
        setChatTitleIfDefault(c, userText);
        persist();
        renderAll();
        scrollToBottom();

        // Assistant placeholder
        const assistantMsg = { role: "assistant", text: "", ts: now() };
        c.messages.push(assistantMsg);
        persist();
        renderMessages();
        scrollToBottom();

        sendBtn.classList.add("hidden");
        stopBtn.classList.remove("hidden");

        abortController = new AbortController();

        try {
          const res = await fetch("/api/chat/stream", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            signal: abortController.signal,
            body: JSON.stringify({
              message: userText,
              previous_response_id: previousResponseId || "",
            }),
          });

          if (!res.ok || !res.body) {
            assistantMsg.text = "Êä±Ê≠âÔºåÊúçÂä°Âô®ËøîÂõûÈîôËØØ„ÄÇ";
            persist();
            renderMessages();
            return;
          }

          const reader = res.body.getReader();
          const decoder = new TextDecoder("utf-8");
          let buf = "";

          while (true) {
            const { value, done } = await reader.read();
            if (done) break;
            buf += decoder.decode(value, { stream: true });

            // parse SSE (very simple)
            let idx;
            while ((idx = buf.indexOf("\n\n")) >= 0) {
              const chunk = buf.slice(0, idx).trim();
              buf = buf.slice(idx + 2);

              if (!chunk) continue;
              const lines = chunk.split("\n");
              let eventName = "message";
              let dataStr = "";

              for (const line of lines) {
                if (line.startsWith("event:")) eventName = line.slice(6).trim();
                if (line.startsWith("data:")) dataStr += line.slice(5).trim();
              }

              if (!dataStr) continue;

              let payload = null;
              try {
                payload = JSON.parse(dataStr);
              } catch {
                payload = { text: dataStr };
              }

              if (eventName === "delta") {
                assistantMsg.text += payload.text || "";
                renderMessages();
                scrollToBottom();
              } else if (eventName === "meta") {
                // capture response_id
                if (payload && payload.response_id) {
                  previousResponseId = payload.response_id;
                  localStorage.setItem(STORAGE_KEY, previousResponseId);
                }
              } else if (eventName === "done") {
                // final render
                persist();
                renderMessages();
              } else if (eventName === "error") {
                assistantMsg.text = payload?.message || "Êä±Ê≠âÔºåÂèëÁîüÈîôËØØ„ÄÇ";
                persist();
                renderMessages();
              }
            }
          }
        } catch (err) {
          if (err && (err.name === "AbortError" || String(err.message || "").toLowerCase().includes("aborted"))) {
            // user stopped generation
            persist();
            renderMessages();
          } else {
            assistantMsg.text = "Êä±Ê≠âÔºåÊµÅÂºèËØ∑Ê±ÇÂ§±Ë¥•„ÄÇËØ∑Ê£ÄÊü•ÊúçÂä°Âô®Êó•Âøó„ÄÇ";
            console.error(err);
            persist();
            renderMessages();
          }
        } finally {
          abortController = null;
          sendBtn.classList.remove("hidden");
          stopBtn.classList.add("hidden");
          renderChatList();
        }
      }

      function sendCurrent() {
        const text = (chatInputEl.value || "").trim();
        if (!text) return;
        chatInputEl.value = "";
        autoGrowTextarea(chatInputEl);
        streamChat(text);
      }

      chatInputEl.addEventListener("input", () => autoGrowTextarea(chatInputEl));

      chatInputEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendCurrent();
        }
      });

      sendBtn.addEventListener("click", sendCurrent);

      stopBtn.addEventListener("click", () => {
        abortController?.abort();
      });

      // ----------------------------
      // Render all
      // ----------------------------
      function renderAll() {
        renderChatList();
        renderMessages();
        renderExamplePrompts();
      }

      // init
      loadState();
      applyChatFromUrl();
      applySidebarState();
      renderAll();
      autoGrowTextarea(chatInputEl);
    </script>
  </body>
</html>
